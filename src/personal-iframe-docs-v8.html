<html>
<head>
    <script>

        function getToken() {
            return "EwBIA61DBAAUTiVFeGt35mbkQxMI9wgOQmfZjKAAAZbw40WBgHvzWN1sugN/bqw4GfzhSPynpcFjdG33OFUtUYFoswI0wwjuNIEIfzrdwYDXQhWyZijUmK8HmSxt33eXK7gTWV6V4Xp2DR1Fu84qn3YjXZjpBxWGs5cQ5EXWpO5rEbA3T72ZJnnA0NsWoz2FVOWFS0KmA4Y8pYHWnFumEZAm1jhol+XUEf39WeYsfwjs1Pj/GoNdVqwlRm4t5r3RV8KS098eyPJQSvXy/37B/CN/EZEE62bM08bRTZ1uqP/wdeaeF4BJsLbkRA0c+rqpmcTjwz3D6MKvyWbhjjuATyUAp6jqNOivwN9TKQ3bzRwDgT6z6mxvTnl49kq8BTgDZgAACAB02Z8yJJVIGAIX5LkI5jH9OJwuTC9adwxCxycL6RQsnXj8ZpZHGfcGKNf3inU3moQ+sSJ36p4n8NeA5Q6cypeATGG7z0VKCQlX6NJqa2osvvDa4ZZbJuHbNXhBouP2ofjZmlJgnfODHVuF48B71j7GYtfSjj8nP+vGdGq6pcOMZRafw8jR9g6WoHZI4H/E4wyfX2xHu+f/QnkL7lUtoYWdeme1LQj/xT//AKctxN8Bkh9LxW2ucIQ0zKHTv/AFw0b8H5xz8/oplgi4LvEVUDFUvKUSx8+bnAM9uJEhDf7lXogl27DOnnITZW12jcUd5eewbWpaMDjM46PyDqq2Fe6OAQPp3JpyLqNArgiFnZrUkgFPF/lx1yG8BjXBr6MqYaSW2aMfZvTXU6H8l8FppFZ08n7ATvNLAl9M2xr4MqkcDBXtz1nyCyzJCJer3kfW0MlNRme1AHUbUnpPzmLt554OQoOZQ/rKwkAbhZoku00H1ZfOwsFYEmJUPUv5fpx/ZXi9C+mFb9qgs68jFPlfMVzcpdUC0BMkATc/2blL+XH8JG/4bXGu/6twUwb2eQqxhJQNcfAhX+Fyr3VvJ7CXRKtR2U+HjlJ/8I9t5O2pZYDJikyvXEKWA34fQZdvLNgXxtTWBi18bL1QQm0ObhKBhwGVXjwjEwEaC1Qk2euox2+fRaWsV3fy/hFARB/AX9Tp8L+zOrJIAl72tQgyPbiSBfvlw0cC";
        }

        const baseUrl = "https://onedrive.live.com/picker";

        // the options we pass to the picker page through the querystring
        const params = {
            sdk: "8.0",
            entry: {
                oneDrive: {
                    files: {},
                }
            },
            authentication: {},
            messaging: {
                origin: "http://localhost:3000",
                channelId: "27"
            },
            typesAndSources: {
                mode: "files",
                pivots: {
                    oneDrive: true,
                    recent: true,
                },
            },
        };

        let win = null;
        let port = null;
        let frame = null;

        async function launchPicker(e) {

            e.preventDefault();

            frame = document.getElementById("iframe");
            win = frame.contentWindow;

            const authToken = getToken();

            const queryString = new URLSearchParams({
                filePicker: JSON.stringify(params),
            });

            const url = `${baseUrl}?${queryString}`;

            const form = win.document.createElement("form");
            form.setAttribute("action", url);
            form.setAttribute("method", "POST");
            win.document.body.append(form);

            const input = win.document.createElement("input");
            input.setAttribute("type", "hidden")
            input.setAttribute("name", "access_token");
            input.setAttribute("value", authToken);
            form.appendChild(input);

            form.submit();

            window.addEventListener("message", (event) => {

                if (event.source && event.source === win) {

                    const message = event.data;

                    if (message.type === "initialize" && message.channelId === params.messaging.channelId) {

                        port = event.ports[0];

                        port.addEventListener("message", messageListener);

                        port.start();

                        port.postMessage({
                            type: "activate",
                        });
                    }
                }
            });
        }

        async function messageListener(message) {
            switch (message.data.type) {

                case "notification":
                    console.log(`notification: ${message.data}`);
                    break;

                case "command":

                    port.postMessage({
                        type: "acknowledge",
                        id: message.data.id,
                    });

                    const command = message.data.data;

                    switch (command.command) {

                        case "authenticate":

                            const token = getToken();

                            if (typeof token !== "undefined" && token !== null) {

                                port.postMessage({
                                    type: "result",
                                    id: message.data.id,
                                    data: {
                                        result: "token",
                                        token,
                                    }
                                });

                            } else {
                                console.error(`Could not get auth token for command: ${JSON.stringify(command)}`);
                            }

                            break;

                        case "close":

                            win.close();
                            break;

                        case "pick":

                            console.log(`Picked: ${JSON.stringify(command)}`);

                            document.getElementById("pickedFiles").innerHTML = `<pre>${JSON.stringify(command, null, 2)}</pre>`;

                            port.postMessage({
                                type: "result",
                                id: message.data.id,
                                data: {
                                    result: "success",
                                },
                            });

                            win.close();

                            break;

                        default:

                            console.warn(`Unsupported command: ${JSON.stringify(command)}`, 2);

                            port.postMessage({
                                result: "error",
                                error: {
                                    code: "unsupportedCommand",
                                    message: command.command
                                },
                                isExpected: true,
                            });
                            break;
                    }

                    break;
            }
        }

    </script>

</head>

<body>
    <button id="launchPicker">Launch Picker</button>
    <br />
    <div id="pickedFiles"></div>
    <iframe class="w-100 mt-3" id="iframe" frameborder="0" style="width:800px;height:600px"></iframe>
</body>

<script type="text/javascript">

    document.getElementById("launchPicker").onclick = launchPicker;

</script>

</html>